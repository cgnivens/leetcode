# https://leetcode.com/problems/minimize-deviation-in-array/
from typing import List


"""
How to solve

[4, 1, 5, 20, 3]

How do we know we want to start with 20?
It's farthest away from the other values. First, let's brute force.

We know if a value is even we can divide it and if it's odd we can multiply it.

Start with the first item and divide:
[2, 1, 5, 20, 3]
Then the second
[2, 2, 5, 20, 3]

This starts to look like a tree problem

       val_1
  op         no-op


However, we need to catch a circular case here. Define the depth of a tree for each
element. That is, the maximum number of divisions that can occur until a value
is odd. An odd value can only be multiplied once until it is even.

val_1
no-op
op_1
...
op_n (sign flip)

A table of cases catches the sign flip. Now, the brute force way is to generate all
combinations of the values of the table and sum up the number of operations, as well
as get the deviation of the list


We generate a table like:

    # Moves     Value
    =======     =====
    0           4
    1           2
    2           1


For each value in nums. So to get the total number of moves, we simply sum
the values in position 0 on the tuples, and find the min/max in position 1, and minimize
the deviation from there.

def indefinite_iterator(it, *iterators):
    if iterators:
        yield from ((val, *chunk) for chunk in indefinite_iterator(*iterators) for val in it)
    else:
        yield from ((val,) for val in it)


Our recursive iterator hits a recursion error. No worries, we can fix it. Let's generate
a cartesian product using itertools' product rather than rolling our own

Now we need to cut down on the number of test cases that we generate. Let's focus
on the algorithm itself and what's actually being optimized here.

We are defining an optimization function that minimizes the difference
between the largest and smallest values in a list via multiplication or division.

I think we were on to something with the smallest even and largest odd. We can cut down
on intermediate transformations this way. Still generate the operations, but cut out the
middle.

So the goal here is to generate a subset of values that we will transform.
"""
from itertools import product, tee
import sys
from operator import itemgetter
from collections import namedtuple


Bound = namedtuple('Bound', ('index', 'value'))


def get_even_values(val, min_=1):
    i = 0
    result = []

    while (not val % 2) and val > min_:
        result.append((i, val))
        val /= 2
        i += 1

    result.append((i, val))

    return result


def get_odd_values(val, max_=sys.maxsize):
    return [(i, val * (i + 1)) for i in range(2) if val * (i + 1) < max_]



def get_bounds(vals):
    evens = filter(lambda x: not x[1] % 2, enumerate(vals))
    odds = filter(lambda x: x[1] % 2, enumerate(vals))

    def get_max_or_min(it, f, default):
        try:
            return Bound(*f(it, key=itemgetter(1)))
        except:
            return Bound(*default)

    return  get_max_or_min(evens, min, (max(vals), 0)), get_max_or_min(odds, max, (0, len(vals)))





class Solution:
    def minimumDeviation(self, nums: List[int]) -> int:
        nums = sorted(nums)

        # This tabulates out all of the results
        max_val, min_val = max(nums), min(nums)

        smallest_even, largest_odd = get_bounds(nums)

        vals = nums[:smallest_even.index] + nums[largest_odd.index:]
        outside = list(enumerate(nums[smallest_even.index:largest_odd.index]))

        min_dev = max_val - min_val

        value_table = [get_even_values(val, min_val) if not val % 2 else get_odd_values(val) for val in vals]

        # A naive way of generating all possible options here
        for move in product(*value_table):
            move = list(move) + outside
            (_, min_val), (_, max_val) = min(move, key=itemgetter(1)), max(move, key=itemgetter(1))
            min_dev = min((max_val - min_val), min_dev)

        return int(min_dev)



def run_tests():
    s = Solution()
    n = len(tests)

    for i, (case, result) in enumerate(tests, start=1):
        solution = s.minimumDeviation(case)
        try:
            assert solution == result
        except:
            raise RuntimeError(
                f"Bad result for the test case {i}:"
                "\n"
                f" case: {case}"
                "\n"
                f"Expected {result} but got {solution}"
            )
        else:
            print(f"Passed case {i} of {n}")

    print('All test cases passed')


tests = [
    ([1,2,3,4], 1),
    ([4,1,5,20,3], 3),
    ([2,10,8], 3),
    ([9,4,3,6,2], 7),
    ([135834,836419,680692,782524,212751,344904,151812,854509,785665,711553,118450,225619,984089,927522,305363,221331,285523,359469,301309,352860,811160,121335,641379,610328,183633,637056,587508,513675,917257,376603,519307,560079,251287,281137,864540,818533,952649,821606,706074,876301,991947,827960,537837,244156,962031,202991,736005,789378,915307,170879,338873,464822,510193,576150,141686,170041,370531,246984,794898,603031,266890,369233,939309,639763,875624,160573,499240,262482,606556,339549,360057,942245,136356,118044,461767,345309,494942,567487,975821,344774,718333,942136,600779,998962,246095,370384,411034,494093,351765,914237,333122,962424,170428,784896,401346,974354,947835,869224,252495,905915,982928,109701,247308,847013,866577,273712,501449,153278,562836,664600,635005,686627,544873,259726,973403,474178,466904,771336,579599,530909,606286,583501,576873,416937,127372,976497,701599,606552,962481,195908,411251,804448,857390,182998,844085,175265,350947,122776,538026,258960,145100,709073,497166,139583,153253,759108,729462,462661,152063,594710,950094,453404,154555,130903,338490,982255,955181,936282,252912,921070,438173,925986,929970,334475,337409,983529,328188,117987,878252,788072,212328,535997,269357,517213,721062,227391,101266,627052,619136,908011,889483,275927,788124,988961,884221,880588,329607,319804,139993,454746,829225,123123,154944,433619,557438,546116,401699,863421,543349,126922,627007,470126,588376,486935,225634,483215,313258,108722,289667,679671,399926,497517,338331,501312,916667,522865,513887,654970,515745,327362,910088,124788,497728,415837,874326,962534,914517,679838,763867,617703,206020,783550,133018,493480,735601,376639,899263,497104,677995,137827,322159,246162,473984,237133,811471,143429,808764,675338,780159,207233,637064,629454,264526,116339,167983,621029,407748,920428,679244,932157,954625,936052,173418,282060,514009,900869,929253,727791,248500,883706,804943,806245,446152,794597,706132,617765,918897,891775,945278,248070,676359,700642,512573,879090,577253,435511,156318,190258,612323,405276,572466,481703,904515,901973,552105,118236,364573,900127,562128,531137,710881,129285,638289,898869,600938,378479,732708,924457,191293,618826,680650,289436,397799,439211,789907,298663,163073,438399,295869,806211,127959,287482,530997,348158,911773,949576,137778,733327,905729,422394,877362,194156,440333,336669,462485,855773,970880,158566,776539,860463,506148,814890,242237,165592,220969,220789,738983,730903,874618,740863,195583,709552,812699,405589,937667,770804,570062,139164,489824,494430,826883,737350,728875,215338,614815,518578,958160,416369,422173,453071,292793,482450,255833,688618,761946,296482,100060,234764,308164,950691,557939,963192,840582,944783,835038,699441,440631,484286,195850,916964,484508,113859,819947,466555,220356,738065,532830,244267,114041,123001,424183,487952,757475,886588,998746,706957,198712,448957,264074,662844,607071,302062,532759,786206,370587,284058,572443,114713,829229,331612,148055,890469,139251,171324,410015,546662,522916,765772,727170,104622,108519,663671,513993,639925,970552,331041,416971,989737,490147,883797,464859,746080,774731,655465,661698,762669,824830,762955,876027,460269,167023,624503,366088,332119,222393,109466,508526,415145,933186,183819,964796,416603,275600,977622,865800,928142,858765,436246,697066,958917,245251,565688,485446,312795,862625,849766,906197,105176,209920,209697,764113,134857,387478,886160,574838,783723,958913,871572,198576,497139,194978,679547,779890,220034,416661,388637,105291,564546,571791], 891887),
    ([256,4194304,33554432,1048576,32768,131072,64,8192,1024,256,64,67108864,2048,268435456,16384,8388608,16384,4,33554432,1,262144,524288,128,268435456,65536,131072,1,4,134217728,256,8388608,524288,8192,2097152,262144,1048576,8192,134217728,262144,8192,16384,16384,512,16384,134217728,2048,1,256,512,268435456,64,64,131072,2097152,512,131072,524288,2097152,67108864,2097152,16,2048,268435456,16384,536870912,8192,4194304,8388608,536870912,1048576,67108864,1024,65536,4194304,65536,67108864,33554432,4096,262144,8388608,2048,131072,16384,134217728,8,67108864,256,16777216,16384,65536,134217728,2,16777216,67108864,64,2048,131072,67108864,2048,33554432,524288,65536,16384,2097152,64,64,2048,2097152,1,8,8192,65536,32768,262144,256,2097152,1024,134217728,32,128,128,2097152,2097152,2097152,268435456,33554432,268435456,256,1024,4096,16,64,2048,262144,524288,16777216,134217728,16,4194304,4194304,134217728,1048576,8192,4096,128,1,4194304,8192,8388608,4096,256,32768,536870912,65536,67108864,32,262144,512,32768,1,2097152,32768,4,32,16,1024,1024,268435456,32768,2,524288,4096,262144,8388608,8388608,33554432,32,32,16777216,67108864,4194304,1048576,16,16,2,1,256,512,1,4096,268435456,33554432,32,65536,134217728,2,2,8388608,8,67108864,32768,8,262144,33554432,1048576,1,65536,2097152,32,4,1024,2,8192,16384,64,8388608,536870912,16384,4194304,4,2,524288,536870912,4096,67108864,134217728,16777216,128,4194304,2048,16,65536,65536,2097152,16,2097152,16384,1024,4194304,2048,4,65536,2097152,2,8192,1024,64,268435456,4096,4096,33554432,33554432,131072,128,512,524288,128,4096,536870912,8192,33554432,8,4,32,524288,268435456,67108864,65536,512,16,4,1048576,524288,65536,16384,64,33554432,4096,4096,256,262144,32,256,16,16384,131072,268435456,268435456,1048576,4096,33554432,1,4096,268435456,8192,8192,268435456,8192,4194304,32,33554432,16,8,4,8388608,134217728,131072,1024,4194304,65536,268435456,4,8192,67108864,32,4,8388608,1,16384,268435456,8192,134217728,131072,32768,1,4096,131072,32,131072,134217728,16,4194304,32,32,131072,2048,4096,8192,67108864,16384,2097152,8388608,262144,32768,32,262144,1,16,16,131072,512,4194304,1,524288,1,8388608,512,33554432,512,512,8192,1024,8,65536,262144,32,33554432,8,32,131072,4194304,512,536870912,268435456,67108864,2,268435456,4194304,536870912,32,4096,8388608,8192,1024,67108864,64,128,1,4194304,4,8192,4,134217728,128,268435456,536870912,1024,64,128,128,4,32,32768,2097152,268435456,32768,131072,128,64,65536,2,32768,4,131072,524288,4194304,64,134217728,4,131072,16777216,262144,32,65536,1048576,128,33554432,256,65536,2048,16384,65536,2097152,524288,2048,2097152,8192,128,536870912,2048,16,33554432,134217728,2048,8,134217728,512,33554432,524288,64,256,268435456,8192,67108864,256,16777216,536870912,1,16384,134217728,16384,128,4194304,4096,32,16384,1048576,32768,2097152,16,8388608,262144,64,131072,16,16777216,4194304,67108864,2048,4194304,4194304,32,134217728,131072,128,65536,536870912,131072,256,32768,32,16384,33554432,65536,131072,64,1024,512,4,128,4,131072,512,8388608,4096,65536,536870912,268435456,256,4096,32,1048576,268435456,1,32,512,16777216,536870912,8192,268435456,2,4,4,1,262144,4096,16384,8192,65536,8192,16,512,8,16384,524288,4,262144,64,4,8,268435456,262144,8,262144,33554432,131072,536870912,33554432,8,536870912,268435456,33554432,32768,256,256,524288,16,262144,131072,32768,8192,16,134217728,536870912,2048,524288,16384,536870912,16,32,131072,64,1,1048576,2048,16777216,512,4096,16777216,2,536870912,8,134217728,32768,4,262144,67108864,33554432,134217728,4,16,8192,4194304,524288,4,8,16384,2,512,16,32,4194304,16,2048,256,512,16384,67108864,32,8388608,64,536870912,67108864,4096,128,4,262144,32,268435456,268435456,16777216,268435456,131072,8,536870912,128,16777216,4,128,262144,2097152,1024,32768,16777216,67108864,128,1,67108864,128,4096,1,128,16384,32,256,524288,67108864,128,8192,33554432,4,65536,4194304,134217728,1024,16777216,268435456,1048576,64,524288,1,1048576,4194304,536870912,8192,512,4,262144,262144,1024,33554432,2097152,64,67108864,2,1024,268435456,1024,512,268435456,268435456,4194304,268435456,16777216,16,32,536870912,128,4096,134217728,4096,4,1048576,256,4096,4096,8388608,64,262144,512,67108864,536870912,32,2048,1024,262144,16777216,16777216,262144,2,8,256,2,262144,4,4,2,2097152,1,16777216,512,4096,128,8192,16,33554432,256,16777216,262144,1,33554432,64,4096,2048,4194304,32,8388608,32768,65536,256,256,128,268435456,1024,1024,4194304,268435456,262144,16384,67108864,2097152,65536,65536,4,4096,2097152,512,16777216,131072,128,262144,16384,65536,4194304,8388608,2048,1024,16777216,65536,8192,1,262144,2,134217728,16384,128,33554432,1,1024,4194304,512,4096,8388608,8388608,512,8192,8192,67108864,16777216,32,262144,4194304,65536,1,524288,32,1048576,134217728,2048,128,128,1,268435456,536870912,536870912,512,16384,2097152,65536,2097152,32,33554432,4096,2097152,8388608,1048576,16384,1024,67108864,2048,16384,1,2,512,2048,8192,65536,32,524288,262144,536870912,16777216,8192,2,2048,1048576,512,262144,1024,32,16777216,131072,131072,128,536870912,512,256,134217728,8192,4,67108864,16,64,1024,1024,8388608,65536,2048,65536,2097152,16777216,128,8192,2097152,4194304,512,8,2048,1,64,2,134217728,2097152,2048,4,16777216,32,1048576,4,32768,262144,67108864,2097152,16777216,16384,4194304,4,262144,16777216,1024,2,67108864,536870912,4194304,8192,16,4,1,8,131072,268435456,1024,536870912,4,4194304,16777216,2048,16384,64,2097152,32768,262144,262144,64,32768,64,16777216,2,33554432,1,32,2097152,268435456,8192,262144,524288,8,16384,67108864,524288,16777216,131072,8388608,2048,1024,2048,512,65536,8192,1,536870912,4194304,512,4194304,67108864,2097152,536870912,256,131072,1024,536870912,4096,65536,134217728,256,16777216,4096,2097152,2097152,4096,32768,1048576,67108864,256,16777216,134217728,33554432,524288,32,33554432,16777216,536870912,65536,8388608,256,16777216,524288,134217728,131072,16,524288,32,1,32,2,512,2097152,4194304,256,67108864,128,134217728,65536,536870912,2097152,8388608,1,16777216,268435456,2], None),
]

if __name__ == "__main__":
    run_tests()
